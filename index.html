<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>LouisLiao Piano – Practice Tool</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  padding:24px;
  font-family: system-ui,-apple-system,"PingFang TC","Microsoft JhengHei",sans-serif;
  background:radial-gradient(1200px 600px at 20% 0%,#1b1b1f,#0b0b0f 55%,#07070a);
  color:#f5f5f5;
}
.wrap{max-width:980px;margin:auto}

/* Header */
.header{
  background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  padding:16px;
  box-shadow:0 18px 50px rgba(0,0,0,.45);
}
.title{
  font-size:22px;
  font-weight:900;
  letter-spacing:.08em;
}
.sub{
  font-size:12px;
  letter-spacing:.12em;
  color:rgba(255,255,255,.65);
  margin-top:4px;
}
.toolbar{
  display:flex;
  gap:12px;
  margin-top:14px;
  flex-wrap:wrap;
}
.card{
  flex:1 1 260px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px;
  padding:10px 12px;
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
.label{
  font-size:12px;
  letter-spacing:.08em;
  color:rgba(255,255,255,.65);
  white-space:nowrap;
}
.btn{
  padding:8px 12px;
  border-radius:12px;
  border:1px solid rgba(212,177,95,.45);
  background:rgba(212,177,95,.18);
  color:#f6e7bd;
  font-weight:800;
  cursor:pointer;
}
.btn.off{
  background:rgba(255,255,255,.1);
  border-color:rgba(255,255,255,.2);
  color:#fff;
}
.slider{
  flex:1 1 auto;
  min-width:120px;
  accent-color:#d4b15f;
}
.badge{
  margin-left:auto;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(212,177,95,.45);
  background:rgba(212,177,95,.18);
  font-weight:800;
  letter-spacing:.08em;
  white-space:nowrap;
}

/* Keyboard */
.panel{
  margin-top:16px;
  background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  padding:16px;
  box-shadow:0 20px 60px rgba(0,0,0,.45);
}
.keyboard{
  position:relative;
  height:280px;
  border-radius:14px;
  overflow:hidden;
  background:linear-gradient(180deg,#f8f8f8,#e9e9ee);
  user-select:none;
  touch-action: manipulation;
}
.white-keys{
  display:flex;
  height:100%;
}
.wkey{
  flex:1;
  border-right:1px solid rgba(0,0,0,.15);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  padding-bottom:10px;
  font-weight:700;
  color:rgba(0,0,0,.35);
  min-width:0;
}
.wkey:last-child{border-right:0}
.wkey.active{
  box-shadow:inset 0 0 0 999px rgba(212,177,95,.25);
}

.black-keys{
  position:absolute;
  inset:0;
  pointer-events:none;
}
.bkey{
  position:absolute;
  top:0;
  /* ✅ 寬度改由 JS 動態指定（避免三個八度變窄時重疊） */
  height:62%;
  background:linear-gradient(180deg,#2a2a2f,#0b0b0f);
  border-radius:0 0 10px 10px;
  box-shadow:0 12px 18px rgba(0,0,0,.6);
  pointer-events:auto;
}
.bkey.active{
  box-shadow:inset 0 0 0 999px rgba(212,177,95,.25),0 12px 18px rgba(0,0,0,.6);
}

.footer{
  margin-top:10px;
  font-size:13px;
  color:rgba(255,255,255,.6);
}
</style>
</head>

<body>
<div class="wrap">

  <div class="header">
    <div class="title">LouisLiao Piano</div>
    <div class="sub">Web Practice Tool · 3 Octaves</div>

    <div class="toolbar">
      <div class="card">
        <span class="label">METRONOME</span>
        <button id="metroBtn" class="btn off">OFF</button>
        <span class="label">BPM <b id="bpmText">120</b></span>
        <input id="bpm" class="slider" type="range" min="40" max="220" value="120">
      </div>
      <div class="card">
        <span class="label">MIDI</span>
        <span id="midiStatus" class="badge">CHECKING…</span>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="keyboard">
      <div class="white-keys" id="whiteKeys"></div>
      <div class="black-keys" id="blackKeys"></div>
    </div>
    <div class="footer">
      電腦鍵盤：A S D F G H J K（對齊中間 C4）
    </div>
  </div>

</div>

<script>
(()=>{

/* ====== CONFIG: 三個八度（C3–C6） ====== */
const START = 48; // C3
const END   = 84; // C6

/* ====== AUDIO ====== */
let ctx;
const voices=new Map();
const freq=m=>440*Math.pow(2,(m-69)/12);
const ensure=()=>{ ctx ??= new (window.AudioContext || window.webkitAudioContext)(); if(ctx.state==="suspended") ctx.resume(); };

const noteOn=(m,v=100)=>{
  ensure();
  if(voices.has(m)) return;
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.type="sine"; o.frequency.value=freq(m);

  const vel=Math.max(0,Math.min(127,v));
  const amp=0.02 + (vel/127)*0.23;

  const t=ctx.currentTime;
  g.gain.setValueAtTime(0.0001,t);
  g.gain.exponentialRampToValueAtTime(amp,t+0.01);

  o.connect(g).connect(ctx.destination);
  o.start(t);

  voices.set(m,{o,g});
  highlight(m,true);
};

const noteOff=(m)=>{
  const v=voices.get(m);
  if(!v || !ctx) return;
  const t=ctx.currentTime;
  v.g.gain.cancelScheduledValues(t);
  v.g.gain.setValueAtTime(Math.max(v.g.gain.value,0.0001),t);
  v.g.gain.exponentialRampToValueAtTime(0.0001,t+0.08);
  v.o.stop(t+0.09);
  voices.delete(m);
  highlight(m,false);
};

/* ====== KEYBOARD UI ====== */
const isBlack=m=>[1,3,6,8,10].includes(m%12);
const whiteLabel={0:"C",2:"D",4:"E",5:"F",7:"G",9:"A",11:"B"};

const wk=document.getElementById("whiteKeys");
const bk=document.getElementById("blackKeys");
const elMap=new Map();

const whites=[];
for(let m=START;m<=END;m++) if(!isBlack(m)) whites.push(m);

const totalWhites = whites.length;
const whitePct = 100 / totalWhites;       // 每顆白鍵的寬度（%）
const blackPct = whitePct * 0.62;         // ✅ 黑鍵寬度跟著白鍵比例縮放
const blackOffset = whitePct * 0.69;      // ✅ 黑鍵落在兩個白鍵之間略偏右（視覺像鋼琴）

whites.forEach(m=>{
  const d=document.createElement("div");
  d.className="wkey";
  d.textContent=whiteLabel[m%12] || "";
  d.addEventListener("pointerdown",(e)=>{e.preventDefault(); noteOn(m,110); d.setPointerCapture(e.pointerId);});
  d.addEventListener("pointerup",()=>noteOff(m));
  d.addEventListener("pointercancel",()=>noteOff(m));
  wk.appendChild(d);
  elMap.set(m,d);
});

// 回傳某個 midi 前面有幾顆白鍵
const whiteIndexForMidi=(midi)=>{
  let c=0;
  for(let m=START;m<midi;m++) if(!isBlack(m)) c++;
  return c;
};

// 生成黑鍵（位置與寬度都用動態計算，不會重疊）
for(let m=START;m<=END;m++){
  if(!isBlack(m)) continue;

  const leftWhiteIdx = whiteIndexForMidi(m) - 1;   // 黑鍵左邊那顆白鍵 index
  const leftPct = (leftWhiteIdx / totalWhites) * 100;

  const d=document.createElement("div");
  d.className="bkey";
  d.style.width = blackPct + "%";
  d.style.left  = `calc(${leftPct}% + ${blackOffset}%)`;

  d.addEventListener("pointerdown",(e)=>{e.preventDefault(); noteOn(m,110); d.setPointerCapture(e.pointerId);});
  d.addEventListener("pointerup",()=>noteOff(m));
  d.addEventListener("pointercancel",()=>noteOff(m));

  bk.appendChild(d);
  elMap.set(m,d);
}

function highlight(m,on){
  const el=elMap.get(m);
  if(!el) return;
  el.classList.toggle("active", !!on);
}

/* ====== COMPUTER KEYS（對齊中間 C4） ====== */
const kmap={a:60,s:62,d:64,f:65,g:67,h:69,j:71,k:72};
const down=new Set();
window.addEventListener("keydown",(e)=>{
  const k=e.key.toLowerCase();
  if(!(k in kmap) || down.has(k)) return;
  down.add(k);
  noteOn(kmap[k],100);
});
window.addEventListener("keyup",(e)=>{
  const k=e.key.toLowerCase();
  if(!(k in kmap)) return;
  down.delete(k);
  noteOff(kmap[k]);
});

/* ====== METRONOME ====== */
let bpm=120, timer=null, metroOn=false;
const btn=document.getElementById("metroBtn");
const bpmEl=document.getElementById("bpm");
const bpmT=document.getElementById("bpmText");

const click=()=>{
  ensure();
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.type="square"; o.frequency.value=1400;
  const t=ctx.currentTime;
  g.gain.setValueAtTime(0.0001,t);
  g.gain.exponentialRampToValueAtTime(0.18,t+0.001);
  g.gain.exponentialRampToValueAtTime(0.0001,t+0.03);
  o.connect(g).connect(ctx.destination);
  o.start(t); o.stop(t+0.04);
};

function refreshMetro(){
  clearInterval(timer);
  timer=null;
  if(metroOn){
    click();
    timer=setInterval(click, Math.round(60000/bpm));
  }
}

btn.addEventListener("click",()=>{
  metroOn=!metroOn;
  btn.textContent=metroOn?"ON":"OFF";
  btn.classList.toggle("off", !metroOn);
  refreshMetro();
});

bpmEl.addEventListener("input",()=>{
  bpm=Number(bpmEl.value);
  bpmT.textContent=String(bpm);
  refreshMetro();
});

/* ====== MIDI ====== */
const ms=document.getElementById("midiStatus");
if(!navigator.requestMIDIAccess){
  ms.textContent="UNSUPPORTED";
}else{
  navigator.requestMIDIAccess().then(acc=>{
    ms.textContent="READY";
    const bind=(input)=>{
      input.onmidimessage=(e)=>{
        const [status,note,vel]=e.data;
        const cmd = status & 0xF0;
        if(cmd===0x90 && vel>0) noteOn(note,vel);
        else if(cmd===0x80 || (cmd===0x90 && vel===0)) noteOff(note);
      };
    };
    for(const input of acc.inputs.values()) bind(input);
    acc.onstatechange=()=>{ for(const input of acc.inputs.values()) bind(input); };
  }).catch(()=>ms.textContent="BLOCKED");
}

})();
</script>
</body>
</html>
