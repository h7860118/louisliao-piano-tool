<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>LouisLiao Piano – Practice Tool</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  padding:24px;
  font-family: system-ui,-apple-system,"PingFang TC","Microsoft JhengHei",sans-serif;
  background:radial-gradient(1200px 600px at 20% 0%,#1b1b1f,#0b0b0f 55%,#07070a);
  color:#f5f5f5;
}
.wrap{max-width:980px;margin:auto}

/* Header */
.header{
  background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  padding:16px;
  box-shadow:0 18px 50px rgba(0,0,0,.45);
}
.title{
  font-size:22px;
  font-weight:900;
  letter-spacing:.08em;
}
.sub{
  font-size:12px;
  letter-spacing:.12em;
  color:rgba(255,255,255,.65);
  margin-top:4px;
}
.toolbar{
  display:flex;
  gap:12px;
  margin-top:14px;
  flex-wrap:wrap;
}
.card{
  flex:1 1 260px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px;
  padding:10px 12px;
  display:flex;
  align-items:center;
  gap:10px;
}
.label{
  font-size:12px;
  letter-spacing:.08em;
  color:rgba(255,255,255,.65);
}
.btn{
  padding:8px 12px;
  border-radius:12px;
  border:1px solid rgba(212,177,95,.45);
  background:rgba(212,177,95,.18);
  color:#f6e7bd;
  font-weight:800;
  cursor:pointer;
}
.btn.off{
  background:rgba(255,255,255,.1);
  border-color:rgba(255,255,255,.2);
  color:#fff;
}
.slider{
  flex:1;
  accent-color:#d4b15f;
}
.badge{
  margin-left:auto;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(212,177,95,.45);
  background:rgba(212,177,95,.18);
  font-weight:800;
  letter-spacing:.08em;
}

/* Keyboard */
.panel{
  margin-top:16px;
  background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  padding:16px;
  box-shadow:0 20px 60px rgba(0,0,0,.45);
}
.keyboard{
  position:relative;
  height:280px;
  border-radius:14px;
  overflow:hidden;
  background:linear-gradient(180deg,#f8f8f8,#e9e9ee);
}
.white-keys{
  display:flex;
  height:100%;
}
.wkey{
  flex:1;
  border-right:1px solid rgba(0,0,0,.15);
  display:flex;
  justify-content:center;
  align-items:flex-end;
  padding-bottom:10px;
  font-weight:700;
  color:rgba(0,0,0,.35);
}
.wkey.active{
  box-shadow:inset 0 0 0 999px rgba(212,177,95,.25);
}
.black-keys{
  position:absolute;
  inset:0;
  pointer-events:none;
}
.bkey{
  position:absolute;
  top:0;
  width:5.8%;
  height:62%;
  background:linear-gradient(180deg,#2a2a2f,#0b0b0f);
  border-radius:0 0 10px 10px;
  box-shadow:0 12px 18px rgba(0,0,0,.6);
  pointer-events:auto;
}
.bkey.active{
  box-shadow:inset 0 0 0 999px rgba(212,177,95,.25),0 12px 18px rgba(0,0,0,.6);
}
.footer{
  margin-top:10px;
  font-size:13px;
  color:rgba(255,255,255,.6);
}
</style>
</head>

<body>
<div class="wrap">

  <div class="header">
    <div class="title">LouisLiao Piano</div>
    <div class="sub">Web Practice Tool · 3 Octaves</div>

    <div class="toolbar">
      <div class="card">
        <span class="label">METRONOME</span>
        <button id="metroBtn" class="btn off">OFF</button>
        <span class="label">BPM <b id="bpmText">120</b></span>
        <input id="bpm" class="slider" type="range" min="40" max="220" value="120">
      </div>
      <div class="card">
        <span class="label">MIDI</span>
        <span id="midiStatus" class="badge">CHECKING…</span>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="keyboard">
      <div class="white-keys" id="whiteKeys"></div>
      <div class="black-keys" id="blackKeys"></div>
    </div>
    <div class="footer">
      電腦鍵盤：A S D F G H J K（對齊中間 C4）
    </div>
  </div>

</div>

<script>
(()=>{

/* ====== CONFIG: 三個八度（和你貼的那張一樣） ====== */
const START = 48; // C3
const END   = 84; // C6

/* ====== AUDIO ====== */
let ctx;
const voices=new Map();
const freq=m=>440*Math.pow(2,(m-69)/12);
const ensure=()=>{ctx??=new(AudioContext||webkitAudioContext)();ctx.resume()};
const on=(m,v=100)=>{
  ensure();
  if(voices.has(m))return;
  const o=ctx.createOscillator(),g=ctx.createGain();
  o.type="sine";o.frequency.value=freq(m);
  g.gain.setValueAtTime(.001,ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(.25,ctx.currentTime+.01);
  o.connect(g).connect(ctx.destination);
  o.start();
  voices.set(m,{o,g});
  key(m,true);
};
const off=m=>{
  const v=voices.get(m);if(!v)return;
  v.g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.08);
  v.o.stop(ctx.currentTime+.1);
  voices.delete(m);
  key(m,false);
};

/* ====== KEYS ====== */
const isBlack=m=>[1,3,6,8,10].includes(m%12);
const wl={0:"C",2:"D",4:"E",5:"F",7:"G",9:"A",11:"B"};
const wk=document.getElementById("whiteKeys");
const bk=document.getElementById("blackKeys");
const mapEl=new Map();
const whites=[];
for(let m=START;m<=END;m++)if(!isBlack(m))whites.push(m);
whites.forEach(m=>{
  const d=document.createElement("div");
  d.className="wkey";d.textContent=wl[m%12]||"";
  d.onpointerdown=e=>{e.preventDefault();on(m);d.setPointerCapture(e.pointerId)};
  d.onpointerup=()=>off(m);
  wk.appendChild(d);
  mapEl.set(m,d);
});
const idx=m=>whites.filter(w=>w<m).length;
for(let m=START;m<=END;m++){
  if(!isBlack(m))continue;
  const d=document.createElement("div");
  d.className="bkey";
  const p=(idx(m)-1)/whites.length*100;
  d.style.left=`calc(${p}% + ${(100/whites.length)*.7}%)`;
  d.onpointerdown=e=>{e.preventDefault();on(m);d.setPointerCapture(e.pointerId)};
  d.onpointerup=()=>off(m);
  bk.appendChild(d);
  mapEl.set(m,d);
}
const key=(m,a)=>mapEl.get(m)?.classList.toggle("active",a);

/* ====== COMPUTER KEYS ====== */
const kmap={a:60,s:62,d:64,f:65,g:67,h:69,j:71,k:72};
const down=new Set();
onkeydown=e=>{const k=e.key.toLowerCase();if(kmap[k]&&!down.has(k)){down.add(k);on(kmap[k])}};
onkeyup=e=>{const k=e.key.toLowerCase();if(kmap[k]){down.delete(k);off(kmap[k])}};

/* ====== METRONOME ====== */
let bpm=120,timer=null,onM=false;
const btn=document.getElementById("metroBtn");
const bpmEl=document.getElementById("bpm");
const bpmT=document.getElementById("bpmText");
const click=()=>{
  ensure();
  const o=ctx.createOscillator(),g=ctx.createGain();
  o.frequency.value=1400;o.type="square";
  g.gain.setValueAtTime(.001,ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(.2,ctx.currentTime+.01);
  g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.04);
  o.connect(g).connect(ctx.destination);
  o.start();o.stop(ctx.currentTime+.05);
};
btn.onclick=()=>{
  onM=!onM;
  btn.textContent=onM?"ON":"OFF";
  btn.classList.toggle("off",!onM);
  clearInterval(timer);
  if(onM){click();timer=setInterval(click,60000/bpm);}
};
bpmEl.oninput=()=>{bpm=bpmEl.value;bpmT.textContent=bpm;if(onM){clearInterval(timer);timer=setInterval(click,60000/bpm);}};

/* ====== MIDI ====== */
const ms=document.getElementById("midiStatus");
navigator.requestMIDIAccess?.().then(acc=>{
  ms.textContent="READY";
  for(const i of acc.inputs.values()){
    i.onmidimessage=e=>{
      const[c,n,v]=e.data;
      if((c&0xf0)==0x90&&v>0)on(n,v);
      else if((c&0xf0)==0x80||(c&0xf0)==0x90&&v==0)off(n);
    };
  }
}).catch(()=>ms.textContent="BLOCKED");

})();
</script>
</body>
</html>
